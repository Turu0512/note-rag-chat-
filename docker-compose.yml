version: "3.8"
services:
  note_rag:
    build: .
    env_file:
      - ./.env
    volumes:
      - ./app:/app
    working_dir: /app
    depends_on:
      - chrome
      - ollama # ← 追加（gpt-oss を使う場合）
    ports:
      - "8000:8000"
    environment:
      FORCE_REINDEX: ${FORCE_REINDEX:-}
    entrypoint:
      - "/entrypoint.sh"
    command:
      - "uvicorn"
      - "main:app"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8000"

  chrome:
    image: seleniarm/standalone-chromium:latest
    shm_size: 2g
    ports:
      - "4444:4444"
    environment:
      - SE_NODE_MAX_SESSIONS=1

  ui:
    build: .
    env_file:
      - ./.env
    volumes:
      - ./app:/app
    working_dir: /app
    depends_on:
      - note_rag
    ports:
      - "8501:8501"
    environment:
      NOTE_RAG_API_URL: http://note_rag:8000/query
    entrypoint:
      - "/entrypoint.sh"
    command:
      - "streamlit"
      - "run"
      - "streamlit_app.py"
      - "--server.port"
      - "8501"
      - "--server.address"
      - "0.0.0.0"

  # ← 追加: gpt-oss を動かすローカル推論（Ollama）
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ./ollama:/root/.ollama
    restart: unless-stopped
